name: ğŸš€ Auto Deploy RAULI-VISION

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Test Suite
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
    
    - name: ğŸ“¦ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
    
    - name: ğŸ“¦ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“± Install Frontend Dependencies
      run: |
        cd dashboard
        npm ci
    
    - name: ğŸ”¥ Install Go Dependencies
      run: |
        cd espejo
        go mod download
    
    - name: ğŸŒ Install Python Dependencies
      run: |
        cd cliente-local
        pip install -r requirements.txt
    
    - name: ğŸ§ª Run Tests
      run: |
        cd dashboard && npm test -- --passWithNoTests
        cd ../espejo && go test ./...
        cd ../cliente-local && python -m pytest || true

  build:
    needs: test
    runs-on: ubuntu-latest
    name: ğŸ”¨ Build Applications
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
    
    - name: ğŸ“¦ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'
    
    - name: ğŸ“± Build Frontend
      run: |
        cd dashboard
        npm ci
        npm run build
    
    - name: ğŸ”¥ Build Backend
      run: |
        cd espejo
        go build -o espejo ./cmd/server
    
    - name: ğŸ³ Build Docker Images
      run: |
        docker-compose build
    
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          dashboard/dist/
          espejo/espejo
          docker-compose.yml
        retention-days: 1

  deploy-vercel:
    needs: build
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy to Vercel
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
    
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
    
    - name: ğŸŒ Deploy to Vercel
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./dashboard
        vercel-args: '--prod'

  deploy-render:
    needs: build
    runs-on: ubuntu-latest
    name: ğŸ”¥ Deploy to Render
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts
    
    - name: ğŸ”¥ Trigger Render Deploy
      run: |
        # Render se actualiza automÃ¡ticamente con GitHub webhook
        # Solo necesitamos asegurarnos que render.yaml estÃ© presente
        ls -la render.yaml
        echo "âœ… Render deployment triggered via webhook"

  notify:
    needs: [deploy-vercel, deploy-render]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify Deployment
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.deploy-vercel.result == 'success' && needs.deploy-render.result == 'success'
      run: |
        echo "ğŸ‰ RAULI-VISION deployed successfully!"
        echo "ğŸŒ Frontend: https://your-app.vercel.app"
        echo "ğŸ”¥ Backend: https://your-app.onrender.com"
    
    - name: âŒ Failure Notification
      if: needs.deploy-vercel.result == 'failure' || needs.deploy-render.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        exit 1
