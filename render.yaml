# RAULI-VISION — Render Blueprint
# Espejo y Proxy: Go nativo (Proxy sin CGO = cache en memoria; evita fallo Docker en Render).
# Tras el primer deploy, ESPEJO_URL del proxy debe apuntar a la URL pública del espejo.

services:
  - type: web
    name: espejo-backend
    runtime: go
    rootDir: espejo
    plan: starter
    buildCommand: sh -c 'if [ -d espejo ]; then cd espejo; fi && go mod download && go build -ldflags="-s -w" -o espejo ./cmd/server'
    startCommand: sh -c 'if [ -d espejo ]; then cd espejo; fi && ./espejo'
    envVars:
      - key: PORT
        value: "8080"
      - key: JWT_SECRET
        generateValue: true
      - key: ADMIN_TOKEN
        generateValue: true
      - key: VERSION
        value: "1.0.0"
    healthCheckPath: /api/health

  - type: web
    name: proxy-backend
    runtime: go
    rootDir: cliente-local
    plan: starter
    buildCommand: sh -c 'if [ -d cliente-local ]; then cd cliente-local; fi && go mod download && CGO_ENABLED=0 go build -ldflags="-s -w" -o proxy ./cmd/proxy'
    startCommand: sh -c 'if [ -d cliente-local ]; then cd cliente-local; fi && ./proxy'
    envVars:
      - key: PORT
        value: "3000"
      - key: ESPEJO_URL
        value: https://espejo-backend.onrender.com
        # Tras el primer deploy, si el nombre del servicio cambia, ajustar esta URL en el Dashboard de Render
      - key: CLIENT_ID
        generateValue: true
      - key: CLIENT_SECRET
        generateValue: true
      - key: VERSION
        value: "1.0.0"
    healthCheckPath: /api/health
